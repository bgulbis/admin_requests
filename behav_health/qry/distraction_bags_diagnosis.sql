WITH DOSES AS (
	SELECT DISTINCT
		CLINICAL_EVENT.ENCNTR_ID,
		CLINICAL_EVENT.PERSON_ID
/* 		CASE
			WHEN ORDERS.TEMPLATE_ORDER_ID = 0 THEN ORDERS.ORDER_ID
			ELSE ORDERS.TEMPLATE_ORDER_ID
		END AS ORIG_ORDER_ID,
		pi_from_gmt(CLINICAL_EVENT.EVENT_END_DT_TM, 'America/Chicago') AS DOSE_DATETIME,
		CLINICAL_EVENT.EVENT_ID,
		pi_get_cv_display(CLINICAL_EVENT.EVENT_CD) AS MEDICATION,
		CE_MED_RESULT.ADMIN_DOSAGE AS DOSE,
		pi_get_cv_display(CE_MED_RESULT.DOSAGE_UNIT_CD) AS DOSE_UNIT,
		pi_get_cv_display(CE_MED_RESULT.ADMIN_ROUTE_CD) AS ROUTE,
		pi_get_cv_display(ENCNTR_LOC_HIST.LOC_NURSE_UNIT_CD) AS NURSE_UNIT,
		pi_get_cv_display(ENCNTR_LOC_HIST.MED_SERVICE_CD) AS MED_SERVICE,
		CASE
			WHEN ORDERS.PRN_IND = 1 THEN 'TRUE'
			ELSE 'FALSE'
		END AS PRN_DOSE */
	FROM
		CE_MED_RESULT,
		CLINICAL_EVENT,
		ENCNTR_LOC_HIST
		-- ORDERS
	WHERE
		CLINICAL_EVENT.EVENT_CD IN (
			-- 12016891, -- DIAZEPAM
			-- 37556074, -- ALPRAZOLam
			-- 37556575, -- clonazepam
			-- 37556580, -- clorazepate
			37556586, -- clozapine
			37556731, -- diazepam
			-- 37556893, -- estazolam
			-- 37557010, -- flurazepam
			37557136, -- haloperidol
			37557455, -- LORAzepam
			-- 37557461, -- loxapine
			37557589, -- midazolam
			-- 37557613, -- molindone
			37557716, -- olanzapine
			-- 37557737, -- oxazepam
			-- 37557840, -- pimozide
			-- 37557951, -- quazepam
			37557952, -- quetiapine
			37557990, -- risperidone
			-- 37558155, -- temazepam
			-- 37558256, -- triazolam
			37558381, -- ziprasidone
			51208924, -- aripiprazole
			-- 183117860 -- paliperidone
			-- 423546817, -- asenapine
			-- 467366194, -- iloperidone
			-- 604878099, -- lurasidone
			-- 743177897, -- clobazam
			-- 1793096808, -- brexpiprazole
			-- 2078804373, -- cariprazine
			-- 2180033577, -- pimavanserin
			-- 3364423785, -- lumateperone
			-- 3582691103, -- amisulpride
			-- 3630724891, -- remimazolam
			37556521 -- chlorproMAZINE
		)
		AND CLINICAL_EVENT.EVENT_END_DT_TM BETWEEN
			pi_to_gmt(
				TO_DATE(
					@Prompt('Enter begin date', 'D', , mono, free, persistent, {'01/01/2022 00:00:00'}, User:0), 
					pi_get_dm_info_char_gen('Date Format Mask|FT','PI EXP|Systems Configuration|Date Format Mask')
				), 
				'America/Chicago'
			)
			AND pi_to_gmt(
				TO_DATE(
					@Prompt('Enter end date', 'D', , mono, free, persistent, {'04/01/2022 00:00:00'}, User:1), 
					pi_get_dm_info_char_gen('Date Format Mask|FT','PI EXP|Systems Configuration|Date Format Mask')
				) - 1/86400, 
				'America/Chicago'
			)
		AND CLINICAL_EVENT.VALID_UNTIL_DT_TM > DATE '2099-12-31'
		AND CLINICAL_EVENT.EVENT_ID = CE_MED_RESULT.EVENT_ID
		AND CE_MED_RESULT.VALID_UNTIL_DT_TM > DATE '2099-12-31'
		AND CLINICAL_EVENT.ENCNTR_ID = ENCNTR_LOC_HIST.ENCNTR_ID
		AND ENCNTR_LOC_HIST.BEG_EFFECTIVE_DT_TM <= CLINICAL_EVENT.EVENT_END_DT_TM
		AND ENCNTR_LOC_HIST.TRANSACTION_DT_TM = (
			SELECT MAX(ELH.TRANSACTION_DT_TM)
			FROM ENCNTR_LOC_HIST ELH
			WHERE
				CLINICAL_EVENT.ENCNTR_ID = ELH.ENCNTR_ID
				AND ELH.TRANSACTION_DT_TM <= CLINICAL_EVENT.EVENT_END_DT_TM
				AND ELH.ACTIVE_IND = 1
		)
		AND ENCNTR_LOC_HIST.LOC_NURSE_UNIT_CD IN (
			3224987147, -- HH S SITU
			3224988029, -- HH S OTAC
			1846341943 -- HH 3CP
			-- 1846342787 -- HH 3CIM
		)
		AND ENCNTR_LOC_HIST.END_EFFECTIVE_DT_TM >= CLINICAL_EVENT.EVENT_END_DT_TM
		AND ENCNTR_LOC_HIST.ACTIVE_IND = 1
		-- AND CLINICAL_EVENT.ORDER_ID = ORDERS.ORDER_ID
)

SELECT DISTINCT
    -- PATIENTS.ENCNTR_ID,
	ENCNTR_ALIAS.ALIAS AS FIN,
    NOMENCLATURE.SOURCE_IDENTIFIER AS ICD_10_CODE,
    NOMENCLATURE.SOURCE_STRING AS DIAGNOSIS,
	DIAGNOSIS.DIAG_PRIORITY
FROM
    DIAGNOSIS,
	DOSES,
	ENCNTR_ALIAS,
    NOMENCLATURE
WHERE
    DOSES.ENCNTR_ID = DIAGNOSIS.ENCNTR_ID
    AND DIAGNOSIS.DIAG_TYPE_CD = 26244 -- Final
    AND DIAGNOSIS.NOMENCLATURE_ID = NOMENCLATURE.NOMENCLATURE_ID
    -- AND REGEXP_INSTR(NOMENCLATURE.SOURCE_IDENTIFIER, '^E08|^E10|^E78|^I63|^I68|^F17.2|^I48|^I61.5|^I46') > 0 
    AND NOMENCLATURE.SOURCE_VOCABULARY_CD = 641836527 -- ICD-10-CM
    AND NOMENCLATURE.PRINCIPLE_TYPE_CD = 751 -- Disease or Syndrome
	AND DOSES.ENCNTR_ID = ENCNTR_ALIAS.ENCNTR_ID
	AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 619 -- FIN NBR
	AND ENCNTR_ALIAS.ACTIVE_IND = 1